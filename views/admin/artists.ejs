<!DOCTYPE html>
<html>
<head>
  <title>Manage Artists</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/main.css">
  <meta name="csrf-token" content="<%= csrfToken %>">
</head>
<body class="font-sans bg-white text-black">
  <%- include('../partials/navbar'); %>
  <% const dashboardUrl = user ? (user.role === 'artist' ? '/dashboard/artist' : user.role === 'gallery' ? '/dashboard/gallery' : '/dashboard') : '/dashboard'; %>
  <main class="max-w-3xl mx-auto p-6">
    <div class="border border-gray-200 p-6 rounded shadow">
      <h1 class="text-2xl mb-4 text-center">Artist Management</h1>
      <% if (flash.error && flash.error.length) { %>
        <p class="text-red-600 mb-4"><%= flash.error[0] %></p>
      <% } %>
      <% if (flash.success && flash.success.length) { %>
        <p class="text-green-600 mb-4"><%= flash.success[0] %></p>
      <% } %>
      <button id="new-artist" class="mb-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">New Artist</button>
      <ul id="artist-list" class="space-y-4">
        <% artists.forEach(function(a){ %>
          <li class="bg-white shadow-md rounded border">
            <button class="artist-toggle w-full flex items-center p-4 text-left" data-id="<%= a.id %>">
              <span class="font-semibold flex-1"><%= a.name %></span>
            </button>
            <div class="artist-form-wrapper max-h-0 opacity-0 overflow-hidden transition-all ease-in-out">
              <form class="p-4 space-y-2 artist-form" data-id="<%= a.id %>">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <label class="block text-sm font-medium">Name
                  <input name="name" value="<%= a.name %>" class="mt-1 w-full border rounded px-2 py-1"/>
                </label>
                <label class="block text-sm font-medium">Brief Bio
                  <textarea name="bio" rows="3" class="mt-1 w-full border rounded px-2 py-1"><%= a.bio %></textarea>
                </label>
                <label class="block text-sm font-medium">Extended Bio
                  <textarea name="fullBio" rows="5" class="mt-1 w-full border rounded px-2 py-1"><%= a.fullBio %></textarea>
                </label>
                <label class="block text-sm font-medium">Portrait URL
                  <input name="bioImageUrl" value="<%= a.bioImageUrl %>" class="mt-1 w-full border rounded px-2 py-1"/>
                </label>
                <label class="block text-sm font-medium">Gallery Slug
                  <select name="gallery_slug" class="mt-1 w-full border rounded px-2 py-1">
                    <% galleries.forEach(function(g){ %>
                      <option value="<%= g.slug %>" <%= g.slug === a.gallery_slug ? 'selected' : '' %>><%= g.slug %></option>
                    <% }) %>
                  </select>
                </label>
                <div class="flex gap-2">
                  <button type="submit" class="save-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save</button>
                  <button type="button" class="delete bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Delete</button>
                </div>
              </form>
            </div>
          </li>
        <% }) %>
      </ul>
      <template id="new-artist-template">
        <li class="bg-white shadow-md rounded border">
          <button class="artist-toggle w-full flex items-center p-4 text-left" data-new="true">
            <span class="font-semibold flex-1">New Artist</span>
          </button>
          <div class="artist-form-wrapper max-h-0 opacity-0 overflow-hidden transition-all ease-in-out">
            <form class="p-4 space-y-2 artist-form" data-new="true">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <label class="block text-sm font-medium">Artist ID
                <input name="id" value="<%= generatedId %>" class="mt-1 w-full border rounded px-2 py-1"/>
              </label>
              <label class="block text-sm font-medium">Gallery Slug
                <select name="gallery_slug" class="mt-1 w-full border rounded px-2 py-1">
                  <% galleries.forEach(function(g){ %>
                    <option value="<%= g.slug %>"><%= g.slug %></option>
                  <% }) %>
                </select>
              </label>
              <label class="block text-sm font-medium">Name
                <input name="name" class="mt-1 w-full border rounded px-2 py-1"/>
              </label>
              <label class="block text-sm font-medium">Brief Bio
                <textarea name="bio" rows="3" class="mt-1 w-full border rounded px-2 py-1"></textarea>
              </label>
              <label class="block text-sm font-medium">Extended Bio
                <textarea name="fullBio" rows="5" class="mt-1 w-full border rounded px-2 py-1"></textarea>
              </label>
              <label class="block text-sm font-medium">Portrait URL
                <input name="bioImageUrl" class="mt-1 w-full border rounded px-2 py-1"/>
              </label>
              <div class="flex gap-2">
                <button type="submit" class="save-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save</button>
                <button type="button" class="delete bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Delete</button>
              </div>
            </form>
          </div>
        </li>
      </template>
      <p class="mt-6"><a href="<%= dashboardUrl %>" class="text-blue-600 underline">Back to dashboard</a></p>
    </div>
  </main>
  <footer class="text-center py-6 border-t border-gray-200 mt-12">
    <p class="text-sm text-gray-500">&copy; <%= new Date().getFullYear() %> FineArtSuite</p>
  </footer>
  <script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    function toggleWrapper(wrapper) {
      if (wrapper.style.maxHeight && wrapper.style.maxHeight !== '0px') {
        wrapper.style.maxHeight = '0px';
        wrapper.style.opacity = '0';
      } else {
        wrapper.style.maxHeight = wrapper.scrollHeight + 'px';
        wrapper.style.opacity = '1';
      }
    }
    document.querySelectorAll('.artist-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const wrapper = btn.nextElementSibling;
        toggleWrapper(wrapper);
      });
    });
    function handleForm(form) {
      const btn = form.querySelector('.save-btn');
      let id = form.dataset.id;
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const isNew = form.dataset.new === 'true';
        btn.disabled = true;
        const original = btn.textContent;
        btn.textContent = 'Saving...';
        try {
          if (isNew) {
            const formData = new FormData(form);
            const res = await fetch('/dashboard/artists', { method: 'POST', headers: { 'CSRF-Token': csrfToken }, body: formData });
            if (!res.ok) throw new Error(await res.text() || res.statusText);
            btn.textContent = 'Saved!';
            id = formData.get('id');
            form.dataset.id = id;
            form.dataset.new = 'false';
            form.closest('li').querySelector('.artist-toggle span').textContent = formData.get('name') || id;
            setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 1000);
          } else {
            const dataObj = Object.fromEntries(new FormData(form).entries());
            const res = await fetch('/dashboard/artists/' + encodeURIComponent(id), {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrfToken },
              body: JSON.stringify(dataObj)
            });
            if (!res.ok) throw new Error(await res.text() || res.statusText);
            btn.textContent = 'Saved!';
            setTimeout(() => {
              btn.textContent = original;
              btn.disabled = false;
              toggleWrapper(form.parentElement);
            }, 1000);
          }
        } catch (err) {
          btn.textContent = 'Error';
          setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 2000);
        }
      });
      form.querySelector('.delete').addEventListener('click', async e => {
        e.preventDefault();
        if (!id) {
          form.closest('li').remove();
          return;
        }
        const url = '/dashboard/artists/' + encodeURIComponent(id);
        try {
          const res = await fetch(url, { method: 'DELETE', headers: { 'CSRF-Token': csrfToken } });
          if (!res.ok) throw new Error(await res.text() || res.statusText);
          form.closest('li').remove();
        } catch (err) {
          btn.textContent = 'Error';
          setTimeout(() => { btn.textContent = 'Save'; }, 2000);
        }
      });
    }
    document.querySelectorAll('.artist-form').forEach(handleForm);
    document.getElementById('new-artist').addEventListener('click', () => {
      const tpl = document.getElementById('new-artist-template');
      const li = tpl.content.firstElementChild.cloneNode(true);
      document.getElementById('artist-list').prepend(li);
      const btn = li.querySelector('.artist-toggle');
      const wrapper = li.querySelector('.artist-form-wrapper');
      btn.addEventListener('click', () => toggleWrapper(wrapper));
      handleForm(li.querySelector('form'));
      btn.click();
    });
  </script>
</body>
</html>
