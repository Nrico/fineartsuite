<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Manage Galleries</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/main.css">
  <meta name="csrf-token" content="<%= csrfToken %>">
</head>
<body class="font-sans bg-white text-black">
  <%- include('../partials/navbar'); %>
  <% const dashboardUrl = user ? (user.role === 'artist' ? '/dashboard/artist' : user.role === 'gallery' ? '/dashboard/gallery' : '/dashboard') : '/dashboard'; %>
  <main class="max-w-3xl mx-auto p-6">
    <div class="border border-gray-200 p-6 rounded shadow">
      <h1 class="text-2xl mb-4 text-center">Gallery Management</h1>
      <% if (flash.error && flash.error.length) { %>
        <p class="text-red-600 mb-4"><%= flash.error[0] %></p>
      <% } %>
      <% if (flash.success && flash.success.length) { %>
        <p class="text-green-600 mb-4"><%= flash.success[0] %></p>
      <% } %>
      <button id="new-gallery" class="mb-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">New Gallery</button>
      <ul id="gallery-list" class="space-y-4">
        <% galleries.forEach(function(g){ %>
          <li class="bg-white shadow-md rounded border">
            <div class="gallery-toggle w-full flex items-center p-4 cursor-pointer" data-slug="<%= g.slug %>">
              <span class="font-semibold flex-1"><%= g.name %></span>
              <a href="/<%= g.slug %>" target="_blank" class="view-link text-blue-600 underline text-sm" onclick="event.stopPropagation();">View</a>
            </div>
            <div class="gallery-form-wrapper max-h-0 opacity-0 overflow-hidden transition-all ease-in-out">
              <form class="p-4 space-y-4 gallery-form" data-slug="<%= g.slug %>" enctype="multipart/form-data">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <section class="space-y-2">
                  <h3 class="text-lg font-semibold border-b pb-2 mb-2">Gallery Details</h3>
                  <label class="block text-sm font-medium">Name
                    <input name="name" value="<%= g.name %>" class="mt-1 w-full border rounded px-2 py-1"/>
                  </label>
                  <label class="block text-sm font-medium">Description
                    <textarea name="description" rows="3" class="mt-1 w-full border rounded px-2 py-1"><%= g.description %></textarea>
                  </label>
                  <label class="block text-sm font-medium">Phone
                    <input name="phone" value="<%= g.phone || '' %>" class="mt-1 w-full border rounded px-2 py-1"/>
                  </label>
                  <label class="block text-sm font-medium">Email
                    <input name="email" value="<%= g.email || '' %>" class="mt-1 w-full border rounded px-2 py-1"/>
                  </label>
                  <label class="block text-sm font-medium">Address
                    <textarea name="address" rows="2" class="mt-1 w-full border rounded px-2 py-1"><%= g.address || '' %></textarea>
                  </label>
                  <label class="block text-sm font-medium">Owner
                    <input name="owner" value="<%= g.owner || '' %>" class="mt-1 w-full border rounded px-2 py-1"/>
                  </label>
                </section>
                <section class="space-y-2">
                  <h3 class="text-lg font-semibold border-b pb-2 mb-2">Logo</h3>
                  <label class="block text-sm font-medium">Logo URL
                    <input name="logoUrl" value="<%= g.logo_url || '' %>" class="mt-1 w-full border rounded px-2 py-1"/>
                  </label>
                  <label class="block text-sm font-medium">Logo File
                    <input type="file" name="logoFile" accept="image/*" class="mt-1 w-full"/>
                  </label>
                </section>
                <div class="flex gap-2">
                  <button type="submit" class="save-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save</button>
                  <button type="button" class="delete bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Delete</button>
                </div>
              </form>
            </div>
          </li>
        <% }) %>
      </ul>
      <template id="new-gallery-template">
        <li class="bg-white shadow-md rounded border">
          <div class="gallery-toggle w-full flex items-center p-4 cursor-pointer" data-new="true">
            <span class="font-semibold flex-1">New Gallery</span>
            <a href="#" target="_blank" class="view-link hidden text-blue-600 underline text-sm" onclick="event.stopPropagation();">View</a>
          </div>
          <div class="gallery-form-wrapper max-h-0 opacity-0 overflow-hidden transition-all ease-in-out">
            <form class="p-4 space-y-4 gallery-form" data-new="true" enctype="multipart/form-data">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <section class="space-y-2">
                <h3 class="text-lg font-semibold border-b pb-2 mb-2">Gallery Details</h3>
                <label class="block text-sm font-medium">Name
                  <input name="name" class="mt-1 w-full border rounded px-2 py-1"/>
                </label>
                <label class="block text-sm font-medium">Description
                  <textarea name="description" rows="3" class="mt-1 w-full border rounded px-2 py-1"></textarea>
                </label>
                <label class="block text-sm font-medium">Phone
                  <input name="phone" class="mt-1 w-full border rounded px-2 py-1"/>
                </label>
                <label class="block text-sm font-medium">Email
                  <input name="email" class="mt-1 w-full border rounded px-2 py-1"/>
                </label>
                <label class="block text-sm font-medium">Address
                  <textarea name="address" rows="2" class="mt-1 w-full border rounded px-2 py-1"></textarea>
                </label>
                <label class="block text-sm font-medium">Owner
                  <input name="owner" class="mt-1 w-full border rounded px-2 py-1"/>
                </label>
              </section>
              <section class="space-y-2">
                <h3 class="text-lg font-semibold border-b pb-2 mb-2">Logo</h3>
                <label class="block text-sm font-medium">Logo URL
                  <input name="logoUrl" class="mt-1 w-full border rounded px-2 py-1"/>
                </label>
                <label class="block text-sm font-medium">Logo File
                  <input type="file" name="logoFile" accept="image/*" class="mt-1 w-full"/>
                </label>
              </section>
              <div class="flex gap-2">
                <button type="submit" class="save-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save</button>
                <button type="button" class="delete bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Delete</button>
              </div>
            </form>
          </div>
        </li>
      </template>
      <p class="mt-6"><a href="<%= dashboardUrl %>" class="text-blue-600 underline">Back to dashboard</a></p>
    </div>
  </main>
  <footer class="text-center py-6 border-t border-gray-200 mt-12">
    <p class="text-sm text-gray-500">&copy; <%= new Date().getFullYear() %> FineArtSuite</p>
  </footer>
  <script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    function toggleWrapper(wrapper) {
      if (wrapper.style.maxHeight && wrapper.style.maxHeight !== '0px') {
        wrapper.style.maxHeight = '0px';
        wrapper.style.opacity = '0';
      } else {
        wrapper.style.maxHeight = wrapper.scrollHeight + 'px';
        wrapper.style.opacity = '1';
      }
    }
    document.querySelectorAll('.gallery-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const wrapper = btn.nextElementSibling;
        toggleWrapper(wrapper);
      });
    });
    function handleForm(form) {
      const btn = form.querySelector('.save-btn');
      const toggleBtn = form.closest('li').querySelector('.gallery-toggle');
      const viewLink = toggleBtn.querySelector('.view-link');
      let slug = form.dataset.slug;
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const isNew = form.dataset.new === 'true';
        btn.disabled = true;
        const original = btn.textContent;
        btn.textContent = 'Saving...';
        const formData = new FormData(form);
        const url = isNew ? '/dashboard/galleries' : '/dashboard/galleries/' + encodeURIComponent(slug);
        const method = isNew ? 'POST' : 'PUT';
        try {
          const res = await fetch(url, {
            method,
            headers: { 'CSRF-Token': csrfToken },
            body: formData
          });
          if (!res.ok) throw new Error(await res.text() || res.statusText);
          btn.textContent = 'Saved!';
          if (isNew) {
            const data = await res.json();
            slug = data.slug;
            form.dataset.slug = slug;
            toggleBtn.dataset.slug = slug;
            form.dataset.new = 'false';
          }
          form.closest('li').querySelector('.gallery-toggle span').textContent = formData.get('name') || slug;
          viewLink.href = '/' + slug;
          viewLink.classList.remove('hidden');
          setTimeout(() => {
            btn.textContent = original;
            btn.disabled = false;
            if (!isNew) {
              toggleWrapper(form.parentElement);
            }
          }, 1000);
        } catch (err) {
          btn.textContent = 'Error';
          setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 2000);
        }
      });
      form.querySelector('.delete').addEventListener('click', async e => {
        e.preventDefault();
        if (!slug) {
          form.closest('li').remove();
          return;
        }
        const url = '/dashboard/galleries/' + encodeURIComponent(slug);
        try {
          const res = await fetch(url, { method: 'DELETE', headers: { 'CSRF-Token': csrfToken } });
          if (!res.ok) throw new Error(await res.text() || res.statusText);
          form.closest('li').remove();
        } catch (err) {
          btn.textContent = 'Error';
          setTimeout(() => { btn.textContent = 'Save'; }, 2000);
        }
      });
    }
    document.querySelectorAll('.gallery-form').forEach(handleForm);
    document.getElementById('new-gallery').addEventListener('click', () => {
      const tpl = document.getElementById('new-gallery-template');
      const li = tpl.content.firstElementChild.cloneNode(true);
      document.getElementById('gallery-list').prepend(li);
      const btn = li.querySelector('.gallery-toggle');
      const wrapper = li.querySelector('.gallery-form-wrapper');
      btn.addEventListener('click', () => toggleWrapper(wrapper));
      handleForm(li.querySelector('form'));
      btn.click();
    });
  </script>
</body>
</html>
